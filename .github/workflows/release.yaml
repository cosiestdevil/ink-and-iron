name: Build & Release (Windows)

on:
  push:
    branches:
      - main              # alpha/beta pre-releases from pushes
      - 'v*.*.*'          # release branches like vX.9.0 -> full releases on pushes
    tags:
      - 'v*.*.*-beta'     # create a beta pre-release when this tag is pushed
      - 'v*.*.*'          # create a full release when final tags like vX.9.0 are pushed

permissions:
  contents: write
  id-token: write

env:
  # Set this to your produced .exe name (exact filename in target\release)
  EXE_NAME: ink-and-iron.exe
  # Optional: artifact base name (zip prefix); defaults to exe name without .exe
  ARTIFACT_BASENAME: "ink-and-iron"
  CUDA_COMPUTE_CAP: "75"

jobs:
  build-release:
    runs-on: windows-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout (full history & tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: Compute version (inline)
        id: version
        run: |
          chmod +x ./version.sh
          ./version.sh >> "$GITHUB_OUTPUT"
      - run: |
          echo "VERSION_TAG=${{ steps.version.outputs.tag }}" >> $GITHUB_ENV
      - name: MSVC environment
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2

      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.29
        with:
          cuda: '12.9.0'

      - name: Python & Hugging Face CLI
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -U "huggingface_hub"

      - name: Download models
        shell: pwsh
        run: ./download_models.ps1

      - name: Cargo build (release)
        run: cargo build --all --release

      - name: Collect build outputs
        id: collect
        shell: pwsh
        run: |
          $RelDir = "target\release"
          if (-not (Test-Path $RelDir)) { throw "Release folder not found: $RelDir" }

          if (-not $env:EXE_NAME) { throw "EXE_NAME env var not set" }
          $ExePath = Join-Path $RelDir $env:EXE_NAME
          if (-not (Test-Path $ExePath)) {
            throw "Executable not found: $ExePath"
          }

          $stage = Join-Path $env:RUNNER_TEMP "stage"
          if (Test-Path $stage) { Remove-Item -Recurse -Force $stage }
          New-Item -ItemType Directory -Path $stage | Out-Null

          Copy-Item $ExePath -Destination $stage

          # Copy any DLLs alongside the EXE
          Get-ChildItem -Path $RelDir -Filter *.dll -File | Copy-Item -Destination $stage -Force
          
          if (Test-Path "assets")  { Copy-Item "assets"  -Destination (Join-Path $stage "assets")  -Recurse }
          if (Test-Path "credits") { Copy-Item "credits" -Destination (Join-Path $stage "credits") -Recurse }

          $artifactBase = "${{ steps.version.outputs.artifact_basename }}"
          $zipName = "$artifactBase-${{ steps.version.outputs.version }}.zip"
          $zipPath = Join-Path $env:RUNNER_TEMP $zipName

          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
          Compress-Archive -Path (Join-Path $stage '*') -DestinationPath $zipPath

          "zip_path=$zipPath" >> $env:GITHUB_OUTPUT
          "zip_name=$zipName" >> $env:GITHUB_OUTPUT
      - name: Generate a changelog
        uses: orhun/git-cliff-action@v4
        id: git-cliff
        with:
          config: cliff.toml
          args: --unreleased --tag ${{steps.version.outputs.tag}} --strip header
      - name: Upload asset & create/update release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ${{ steps.collect.outputs.zip_path }}
          asset_name: ${{ steps.collect.outputs.zip_name }}
          tag: ${{ steps.version.outputs.tag }}
          release_name: ${{ steps.version.outputs.name }}
          body: |
            Automated build for ${{ steps.version.outputs.name }}.
            Channel: ${{ steps.version.outputs.channel }}.
            ${{steps.git-cliff.outputs.content}}
          prerelease: ${{ steps.version.outputs.prerelease }}
          overwrite: true
