name: Build & Release

on:
  workflow_call:
    secrets:
      STEAM_SHARED_SECRET:
        required: true
      STEAM_USERNAME:
        required: true
      STEAM_PASSWORD:
        required: true
  push:
    branches:
    #  - main # alpha/beta pre-releases from pushes
      - "v*.*.*" # release branches like vX.9.0 -> full releases on pushes
    tags:
      - "v*.*.*-beta" # create a beta pre-release when this tag is pushed
      - "v*.*.*" # create a full release when final tags like vX.9.0 are pushed

permissions:
  contents: write
  id-token: write

env:
  ARTIFACT_BASENAME: "ink-and-iron"
  CUDA_COMPUTE_CAP: "75"
  STEAM_APP_ID: ${{ vars.STEAM_APP_ID }}

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.version.outputs.tag }}
      name: ${{ steps.version.outputs.name }}
      channel: ${{ steps.version.outputs.channel }}
      prerelease: ${{ steps.version.outputs.prerelease }}
    steps:
      - name: Checkout (full history & tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: Compute version (inline)
        id: version
        shell: bash
        run: |
          chmod +x ./version.sh
          ./version.sh >> "$GITHUB_OUTPUT"
  build-linux-llm-cuda:
    runs-on: ubuntu-latest
    needs: version
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Free space on the HOST runner (this is where it matters)
      - name: Free disk space (host)
        run: |
          set -eux
          df -h
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo apt-get clean
          docker system prune -af || true
          df -h

      # Install CUDA on the HOST (Ubuntu). This avoids /dev/tty + Debian/Ubuntu repo mismatch.
      - name: Install CUDA Toolkit
        id: cuda-toolkit
        uses: Jimver/cuda-toolkit@v0.2.30
        with:
          cuda: "12.9.0"
          method: network

      # Optional but helps: cache cargo/target on the HOST and mount into the container
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2

      - name: Build in SteamRT Sniper (mount host CUDA)
        env:
          IMAGE: registry.gitlab.steamos.cloud/steamrt/sniper/sdk:latest
        run: |
          set -euxo pipefail

          docker pull "$IMAGE"

          # Create dirs to mount (works with rust-cache too)
          mkdir -p "$HOME/.cargo" "$HOME/.rustup" target

          docker run --rm -t \
            -v "$GITHUB_WORKSPACE:/work" \
            -v "$HOME/.cargo:/root/.cargo" \
            -v "$HOME/.rustup:/root/.rustup" \
            -v "${{steps.cuda-toolkit.outputs.CUDA_PATH}}:/usr/local/cuda:ro" \
            -w /work \
            -e CUDA_COMPUTE_CAP="$CUDA_COMPUTE_CAP" \
            -e CUDA_HOME=/usr/local/cuda \
            -e PATH="/usr/local/cuda/bin:/root/.cargo/bin:$PATH" \
            -e LD_LIBRARY_PATH="/usr/local/cuda/lib64:${LD_LIBRARY_PATH:-}" \
            "$IMAGE" \
            bash -lc '
              set -eux
              apt-get update
              apt-get install -y --no-install-recommends ca-certificates curl build-essential pkg-config git

              # Install rustup inside container (cached via mounted /root/.cargo + /root/.rustup)
              if ! command -v cargo >/dev/null 2>&1; then
                curl -sSf https://sh.rustup.rs | sh -s -- -y --profile minimal
              fi
              source /root/.cargo/env
              /usr/local/cuda/bin/nvcc --version || true
              PATH="/usr/local/cuda/bin:$PATH"
              cargo build --package llm-provider-cuda --release
            '

      - name: Collect build outputs
        uses: actions/upload-artifact@v4
        with:
          name: ${{ needs.version.outputs.tag }}-linux-llm-cuda
          path: |
            target/release/libllm_provider_cuda.so
  build-linux-llm-cpu:
    runs-on: ubuntu-latest
    needs: version
    container:
      image: registry.gitlab.steamos.cloud/steamrt/sniper/sdk:latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
      - name: Cargo build (release)
        run: cargo build --package llm-provider-cpu --release
      - name: Collect build outputs
        uses: actions/upload-artifact@v4
        with:
          name: ${{needs.version.outputs.tag}}-linux-llm-cpu
          path: |
            target/release/libllm_provider.so
  build-linux-bin:
    runs-on: ubuntu-latest
    needs: version
    container:
      image: registry.gitlab.steamos.cloud/steamrt/sniper/sdk:latest
    steps:
      - name: Checkout (full history & tags)
        uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Install Dependencies
        run: sudo apt-get update; sudo apt-get install g++ pkg-config libx11-dev libasound2-dev libudev-dev libxkbcommon-x11-0 libwayland-dev
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
      - name: set version env
        shell: bash
        run: |
          echo "VERSION_TAG=${{ needs.version.outputs.tag }}" >> $GITHUB_ENV
      - name: Cargo build (release)
        run: cargo build --release
      - name: Collect build outputs
        uses: actions/upload-artifact@v4
        with:
          name: ${{needs.version.outputs.tag}}-linux-bin
          path: |
            target/release/${{env.ARTIFACT_BASENAME}}
      - name: fetch steam lib
        run: |
          cp target/release/build/steamworks-sys-*/out/libsteam_api.so target/release/libsteam_api.so
      - name: Collect steam lib
        uses: actions/upload-artifact@v4
        with:
          name: ${{needs.version.outputs.tag}}-linux-steam
          path: |
            target/release/libsteam_api.so
  build-windows-llm-cuda:
    runs-on: windows-latest
    needs: version
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: MSVC environment
        uses: ilammy/msvc-dev-cmd@v1
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.29
        with:
          cuda: "12.9.0"
      - name: Cargo build (release)
        run: cargo build --package llm-provider-cuda --release
      - name: Collect build outputs
        uses: actions/upload-artifact@v4
        with:
          name: ${{needs.version.outputs.tag}}-windows-llm-cuda
          path: |
            target/release/llm_provider_cuda.dll
  build-windows-llm-cpu:
    runs-on: windows-latest
    needs: version
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: MSVC environment
        uses: ilammy/msvc-dev-cmd@v1
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
      - name: Cargo build (release)
        run: cargo build --package llm-provider-cpu --release
      - name: Collect build outputs
        uses: actions/upload-artifact@v4
        with:
          name: ${{needs.version.outputs.tag}}-windows-llm-cpu
          path: |
            target/release/llm_provider.dll
  build-windows-bin:
    runs-on: windows-latest
    needs: version
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: MSVC environment
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
      - name: set version env
        shell: bash
        run: |
          echo "VERSION_TAG=${{ needs.version.outputs.tag }}" >> $GITHUB_ENV
      - name: Cargo build (release)
        run: cargo build --release

      - name: Collect build outputs
        uses: actions/upload-artifact@v4
        with:
          name: ${{needs.version.outputs.tag}}-windows-bin
          path: |
            target/release/${{env.ARTIFACT_BASENAME}}.exe

      - name: fetch steam dll
        run: |
          cp target/release/build/steamworks-sys-*/out/steam_api64.dll target/release/steam_api64.dll
      - name: Collect steam dll
        uses: actions/upload-artifact@v4
        with:
          name: ${{needs.version.outputs.tag}}-windows-steam
          path: |
            target/release/steam_api64.dll
  build-mac-llm-metal:
    runs-on: macos-latest
    if: false
    needs: version
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
      - name: Cargo build (release)
        run: cargo build --package llm-provider-mac --release
      - name: Collect build outputs
        uses: actions/upload-artifact@v4
        with:
          name: ${{needs.version.outputs.tag}}-mac-llm-metal
          path: |
            target/release/libllm_provider_mac.dylib
  build-mac-llm-cpu:
    runs-on: macos-latest
    if: false
    needs: version
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
      - name: Cargo build (release)
        run: cargo build --package llm-provider-cpu --release
      - name: Collect build outputs
        uses: actions/upload-artifact@v4
        with:
          name: ${{needs.version.outputs.tag}}-mac-llm-cpu
          path: |
            target/release/libllm_provider.dylib
  build-mac-bin:
    runs-on: macos-latest
    if: false
    needs: version
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
      - name: set version env
        shell: bash
        run: |
          echo "VERSION_TAG=${{ needs.version.outputs.tag }}" >> $GITHUB_ENV
      - name: Cargo build (release)
        run: cargo build --release

      - name: Collect build outputs
        uses: actions/upload-artifact@v4
        with:
          name: ${{needs.version.outputs.tag}}-mac-bin
          path: |
            target/release/${{env.ARTIFACT_BASENAME}}

      - name: fetch steam dll
        run: |
          cp target/release/build/steamworks-sys-*/out/libsteam_api.dylib target/release/libsteam_api.dylib
      - name: Collect steam dll
        uses: actions/upload-artifact@v4
        with:
          name: ${{needs.version.outputs.tag}}-mac-steam
          path: |
            target/release/libsteam_api.dylib

  build-steam-release:
    runs-on: ubuntu-latest
    needs:
      [
        version,
        build-linux-llm-cuda,
        build-linux-llm-cpu,
        build-linux-bin,
        build-windows-llm-cuda,
        build-windows-llm-cpu,
        build-windows-bin,
        #build-mac-llm-metal,
        #build-mac-llm-cpu,
        #build-mac-bin
      ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Python & Hugging Face CLI
        run: |
          python -m pip install --upgrade pip
          pip install -U "huggingface_hub"
      - name: Download models
        run: ./download_models.sh
      - uses: actions/download-artifact@v5
        with:
          path: target/windows
          pattern: ${{needs.version.outputs.tag}}-windows-*
          merge-multiple: true
      - uses: actions/download-artifact@v5
        with:
          path: target/linux
          pattern: ${{needs.version.outputs.tag}}-linux-*
          merge-multiple: true
      - uses: actions/download-artifact@v5
        with:
          path: target/mac
          pattern: ${{needs.version.outputs.tag}}-mac-*
          merge-multiple: true
      - name: Prepare files
        id: collect
        run: |
          cp -r assets target/windows/assets
          cp -r assets target/linux/assets
          #cp -r assets target/mac/assets
          cp -r credits target/windows/credits
          cp -r credits target/linux/credits
          #cp -r credits target/mac/credits
      - uses: CyberAndrii/steam-totp@v1
        name: Generate TOTP
        id: steam-totp
        with:
          shared_secret: ${{ secrets.STEAM_SHARED_SECRET }}
      - uses: game-ci/steam-deploy@v3
        with:
          username: ${{ secrets.STEAM_USERNAME }}
          password: ${{ secrets.STEAM_PASSWORD }}
          totp: ${{ steps.steam-totp.outputs.code }}
          appId: ${{ vars.STEAM_APP_ID }}
          buildDescription: ${{needs.version.outputs.tag}}
          rootPath: target
          depot1Path: windows
          depot2Path: linux
          depot3Path: mac
          releaseBranch: experimental
  build-linux-release:
    runs-on: ubuntu-latest
    needs: [version, build-linux-llm-cuda, build-linux-llm-cpu, build-linux-bin]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Python & Hugging Face CLI
        run: |
          python -m pip install --upgrade pip
          pip install -U "huggingface_hub"
      - name: Download models
        run: ./download_models.sh
      - uses: actions/download-artifact@v5
        with:
          path: target
          pattern: ${{needs.version.outputs.tag}}-linux-*
          merge-multiple: true
      - name: Prepare files
        id: collect
        run: |
          mv assets target/assets
          mv credits target/credits
          cd target
          zip -r "../${{env.ARTIFACT_BASENAME}}-linux.zip" .
      - name: Collect linux bin
        uses: actions/upload-artifact@v4
        with:
          name: ${{needs.version.outputs.tag}}-release-linux
          path: |
            ${{env.ARTIFACT_BASENAME}}-linux.zip
  
  build-mac-release:
    runs-on: ubuntu-latest
    needs: [version, build-mac-llm-metal, build-mac-llm-cpu, build-mac-bin]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Python & Hugging Face CLI
        run: |
          python -m pip install --upgrade pip
          pip install -U "huggingface_hub"
      - name: Download models
        run: ./download_models.sh
      - uses: actions/download-artifact@v5
        with:
          path: target
          pattern: ${{needs.version.outputs.tag}}-mac-*
          merge-multiple: true
      - name: Prepare files
        id: collect
        run: |
          mv assets target/assets
          mv credits target/credits
          cd target
          zip -r "../${{env.ARTIFACT_BASENAME}}-mac.zip" .
      - name: Collect mac bin
        uses: actions/upload-artifact@v4
        with:
          name: ${{needs.version.outputs.tag}}-release-mac
          path: |
            ${{env.ARTIFACT_BASENAME}}-mac.zip
  build-windows-release:
    runs-on: ubuntu-latest
    needs:
      [
        version,
        build-windows-llm-cuda,
        build-windows-llm-cpu,
        build-windows-bin,
      ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Python & Hugging Face CLI
        run: |
          python -m pip install --upgrade pip
          pip install -U "huggingface_hub"
      - name: Download models
        run: ./download_models.sh
      - uses: actions/download-artifact@v5
        with:
          path: target
          pattern: ${{needs.version.outputs.tag}}-windows-*
          merge-multiple: true
      - name: Prepare files
        id: collect
        run: |
          mv assets target/assets
          mv credits target/credits
          cd target
          zip -r "../${{env.ARTIFACT_BASENAME}}-windows.zip" .
      - name: Collect windows bin
        uses: actions/upload-artifact@v4
        with:
          name: ${{needs.version.outputs.tag}}-release-windows
          path: |
            ${{env.ARTIFACT_BASENAME}}-windows.zip
  create-release:
    runs-on: ubuntu-latest
    needs: [
      version, 
      build-linux-release, 
      build-windows-release, 
      #build-mac-release
      ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: Generate a changelog
        uses: orhun/git-cliff-action@v4
        id: git-cliff
        with:
          config: cliff.toml
          args: --unreleased --tag ${{needs.version.outputs.tag}} --strip header
      - uses: actions/download-artifact@v5
        with:
          pattern: ${{needs.version.outputs.tag}}-release-*
          merge-multiple: true
      - name: Display structure of downloaded files
        run: ls
      - name: Upload asset & create/update release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: "${{env.ARTIFACT_BASENAME}}-*.zip"
          file_glob: true
          tag: ${{ needs.version.outputs.tag }}
          release_name: ${{ needs.version.outputs.name }}
          body: |
            Automated build for ${{ needs.version.outputs.name }}.
            Channel: ${{ needs.version.outputs.channel }}.
            ${{steps.git-cliff.outputs.content}}
          prerelease: ${{ needs.version.outputs.prerelease }}
          overwrite: true
