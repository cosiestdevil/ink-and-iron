name: Build & Release

on:
  push:
    branches:
      - main              # alpha/beta pre-releases from pushes
      - 'v*.*.*'          # release branches like vX.9.0 -> full releases on pushes
    tags:
      - 'v*.*.*-beta'     # create a beta pre-release when this tag is pushed
      - 'v*.*.*'          # create a full release when final tags like vX.9.0 are pushed

permissions:
  contents: write
  id-token: write

env:
  ARTIFACT_BASENAME: "ink-and-iron"
  CUDA_COMPUTE_CAP: "75"

jobs:
  build-linux-llm-cuda:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history & tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.29
        with:
          cuda: '12.9.0'
      - name: Compute version (inline)
        id: version
        shell: bash
        run: |
          chmod +x ./version.sh
          ./version.sh >> "$GITHUB_OUTPUT"
      - name: Cargo build (release)
        run: cargo build --package llm-provider-cuda --release
      - name: Collect build outputs
        uses: actions/cache@v4
        with:
          key: ${{steps.version.outputs.tag}}-linux-llm-cuda
          path: |
            target/libllm-provider-cuda.so
  build-linux-llm-cpu:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history & tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
      - name: Compute version (inline)
        id: version
        shell: bash
        run: |
          chmod +x ./version.sh
          ./version.sh >> "$GITHUB_OUTPUT"
      - name: Cargo build (release)
        run: cargo build --package llm-provider-cpu --release
      - name: Collect build outputs
        uses: actions/cache@v4
        with:
          key: ${{steps.version.outputs.tag}}-linux-llm-cpu
          path: |
            target/libllm-provider-cpu.so
  build-linux-bin:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history & tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
      - name: Compute version (inline)
        id: version
        run: |
          chmod +x ./version.sh
          ./version.sh >> "$GITHUB_OUTPUT"
      - name: set version env
        shell: bash
        run: |
          echo "VERSION_TAG=${{ steps.version.outputs.tag }}" >> $GITHUB_ENV
      - name: Cargo build (release)
        run: cargo build --release
      - name: Collect build outputs
        uses: actions/cache@v4
        with:
          key: ${{steps.version.outputs.tag}}-linux-bin
          path: |
            target/{{env.ARTIFACT_BASENAME}}
  build-windows-llm-cuda:
    runs-on: windows-latest
    steps:
      - name: Checkout (full history & tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: MSVC environment
        uses: ilammy/msvc-dev-cmd@v1
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.29
        with:
          cuda: '12.9.0'
      - name: Compute version (inline)
        id: version
        shell: bash
        run: |
          chmod +x ./version.sh
          ./version.sh >> "$GITHUB_OUTPUT"
      - name: Cargo build (release)
        run: cargo build --package llm-provider-cuda --release
      - name: Collect build outputs
        uses: actions/cache@v4
        with:
          key: ${{steps.version.outputs.tag}}-windows-llm-cuda
          path: |
            target/llm-provider-cuda.dll
  build-windows-llm-cpu:
    runs-on: windows-latest
    steps:
      - name: Checkout (full history & tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: MSVC environment
        uses: ilammy/msvc-dev-cmd@v1
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
      - name: Compute version (inline)
        id: version
        shell: bash
        run: |
          chmod +x ./version.sh
          ./version.sh >> "$GITHUB_OUTPUT"
      - name: Cargo build (release)
        run: cargo build --package llm-provider-cpu --release
      - name: Collect build outputs
        uses: actions/cache@v4
        with:
          key: ${{steps.version.outputs.tag}}-windows-llm-cpu
          path: |
            target/llm-provider-cpu.dll
  build-windows-bin:
    runs-on: windows-latest
    steps:
      - name: Checkout (full history & tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: MSVC environment
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
      - name: Compute version (inline)
        id: version
        shell: bash
        run: |
          chmod +x ./version.sh
          ./version.sh >> "$GITHUB_OUTPUT"
      - name: set version env
        shell: bash
        run: |
          echo "VERSION_TAG=${{ steps.version.outputs.tag }}" >> $GITHUB_ENV
      - name: Cargo build (release)
        run: cargo build --release

      - name: Collect build outputs
        uses: actions/cache@v4
        with:
          key: ${{steps.version.outputs.tag}}-windows-bin
          path: |
            target/{{env.ARTIFACT_BASENAME}}.exe

  build-linux-release:
    runs-on: ubuntu-latest
    needs: [build-linux-llm-cuda,build-linux-llm-cpu,build-linux-bin]
    steps:
      - name: Checkout (full history & tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: Compute version (inline)
        id: version
        shell: bash
        run: |
          chmod +x ./version.sh
          ./version.sh >> "$GITHUB_OUTPUT"
      - name: Python & Hugging Face CLI
        run: |
          python -m pip install --upgrade pip
          pip install -U "huggingface_hub"
      - name: Download models
        run: ./download_models.sh
      - name: Collect linux llm cuda
        uses: actions/cache@v4
        with:
          key: ${{steps.version.outputs.tag}}-linux-llm-cuda
          path: |
            target/libllm-provider-cuda.so
      - name: Collect linux llm cpu
        uses: actions/cache@v4
        with:
          key: ${{steps.version.outputs.tag}}-linux-llm-cpu
          path: |
            target/libllm-provider-cpu.so
      - name: Collect linux bin
        uses: actions/cache@v4
        with:
          key: ${{steps.version.outputs.tag}}-linux-bin
          path: |
            target/${{env.ARTIFACT_BASENAME}}
      - name: Prepare files
        id: collect
        run: |
          mv assets target/assets
          mv credits target/credits
          zip -r ${{env.ARTIFACT_BASENAME}}-linux.zip target/
      - name: Collect linux bin
        uses: actions/cache@v4
        with:
          key: ${{steps.version.outputs.tag}}-linux-release
          path: |
            ${{env.ARTIFACT_BASENAME}}-linux.zip
  build-windows-release:
    runs-on: ubuntu-latest
    needs: [build-windows-llm-cuda,build-windows-llm-cpu,build-windows-bin]
    steps:
      - name: Checkout (full history & tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: Compute version (inline)
        id: version
        shell: bash
        run: |
          chmod +x ./version.sh
          ./version.sh >> "$GITHUB_OUTPUT"
      - name: Python & Hugging Face CLI
        run: |
          python -m pip install --upgrade pip
          pip install -U "huggingface_hub"
      - name: Download models
        run: ./download_models.sh
      - name: Collect windows llm cuda
        uses: actions/cache@v4
        with:
          key: ${{steps.version.outputs.tag}}-windows-llm-cuda
          path: |
            target/llm-provider-cuda.dll
      - name: Collect windows llm cpu
        uses: actions/cache@v4
        with:
          key: ${{steps.version.outputs.tag}}-windows-llm-cpu
          path: |
            target/llm-provider-cpu.dll
      - name: Collect windows bin
        uses: actions/cache@v4
        with:
          key: ${{steps.version.outputs.tag}}-windows-bin
          path: |
            target/${{env.ARTIFACT_BASENAME}}.exe
      - name: Prepare files
        id: collect
        run: |
          mv assets target/assets
          mv credits target/credits
          zip -r ${{env.ARTIFACT_BASENAME}}-windows.zip target/
      - name: Collect windows bin
        uses: actions/cache@v4
        with:
          key: ${{steps.version.outputs.tag}}-windows-release
          path: |
            ${{env.ARTIFACT_BASENAME}}-windows.zip
  create-release:
    runs-on: ubuntu-latest
    needs: [build-linux-release, build-windows-release]
    steps:
      - name: Checkout (full history & tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: Compute version (inline)
        id: version
        shell: bash
        run: |
          chmod +x ./version.sh
          ./version.sh >> "$GITHUB_OUTPUT"
      - name: Generate a changelog
        uses: orhun/git-cliff-action@v4
        id: git-cliff
        with:
          config: cliff.toml
          args: --unreleased --tag ${{steps.version.outputs.tag}} --strip header
      - name: Upload asset & create/update release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: "${{env.ARTIFACT_BASENAME}}.*.zip"
          file_glob: true
          tag: ${{ steps.version.outputs.tag }}
          release_name: ${{ steps.version.outputs.name }}
          body: |
            Automated build for ${{ steps.version.outputs.name }}.
            Channel: ${{ steps.version.outputs.channel }}.
            ${{steps.git-cliff.outputs.content}}
          prerelease: ${{ steps.version.outputs.prerelease }}
          overwrite: true    
