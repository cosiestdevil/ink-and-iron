name: Build & Release

on:
  push:
    branches:
      - main # alpha/beta pre-releases from pushes
      - "v*.*.*" # release branches like vX.9.0 -> full releases on pushes
    tags:
      - "v*.*.*-beta" # create a beta pre-release when this tag is pushed
      - "v*.*.*" # create a full release when final tags like vX.9.0 are pushed

permissions:
  contents: write
  id-token: write

env:
  ARTIFACT_BASENAME: "ink-and-iron"
  CUDA_COMPUTE_CAP: "75"
  STEAM_APP_ID: ${{ vars.STEAM_APP_ID }}

jobs:
  build-linux-llm-cuda:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history & tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
      - name: Free disk space
        run: |
          df -h
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean
          docker system prune -af || true
          df -h
      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.29
        with:
          cuda: "12.9.0"
          method: network
      - name: Compute version (inline)
        id: version
        shell: bash
        run: |
          chmod +x ./version.sh
          ./version.sh >> "$GITHUB_OUTPUT"
      - name: Cargo build (release)
        run: cargo build --package llm-provider-cuda --release
      - name: Collect build outputs
        uses: actions/upload-artifact@v4
        with:
          name: ${{steps.version.outputs.tag}}-linux-llm-cuda
          path: |
            target/release/libllm_provider_cuda.so
  build-linux-llm-cpu:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history & tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
      - name: Compute version (inline)
        id: version
        shell: bash
        run: |
          chmod +x ./version.sh
          ./version.sh >> "$GITHUB_OUTPUT"
      - name: Cargo build (release)
        run: cargo build --package llm-provider-cpu --release
      - name: Collect build outputs
        uses: actions/upload-artifact@v4
        with:
          name: ${{steps.version.outputs.tag}}-linux-llm-cpu
          path: |
            target/release/libllm_provider.so
  build-linux-bin:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history & tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Install Dependencies
        run: sudo apt-get update; sudo apt-get install g++ pkg-config libx11-dev libasound2-dev libudev-dev libxkbcommon-x11-0 libwayland-dev
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
      - name: Compute version (inline)
        id: version
        run: |
          chmod +x ./version.sh
          ./version.sh >> "$GITHUB_OUTPUT"
      - name: set version env
        shell: bash
        run: |
          echo "VERSION_TAG=${{ steps.version.outputs.tag }}" >> $GITHUB_ENV
      - name: Cargo build (release)
        run: cargo build --release
      - name: Collect build outputs
        uses: actions/upload-artifact@v4
        with:
          name: ${{steps.version.outputs.tag}}-linux-bin
          path: |
            target/release/${{env.ARTIFACT_BASENAME}}
      - name: Collect steam lib
        uses: actions/upload-artifact@v4
        with:
          name: ${{steps.version.outputs.tag}}-linux-steam
          path: |
            target/release/build/steamworks-sys-*/out/libsteam_api.so
  build-windows-llm-cuda:
    runs-on: windows-latest
    steps:
      - name: Checkout (full history & tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: MSVC environment
        uses: ilammy/msvc-dev-cmd@v1
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.29
        with:
          cuda: "12.9.0"
      - name: Compute version (inline)
        id: version
        shell: bash
        run: |
          chmod +x ./version.sh
          ./version.sh >> "$GITHUB_OUTPUT"
      - name: Cargo build (release)
        run: cargo build --package llm-provider-cuda --release
      - name: Collect build outputs
        uses: actions/upload-artifact@v4
        with:
          name: ${{steps.version.outputs.tag}}-windows-llm-cuda
          path: |
            target/release/llm_provider_cuda.dll
  build-windows-llm-cpu:
    runs-on: windows-latest
    steps:
      - name: Checkout (full history & tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: MSVC environment
        uses: ilammy/msvc-dev-cmd@v1
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
      - name: Compute version (inline)
        id: version
        shell: bash
        run: |
          chmod +x ./version.sh
          ./version.sh >> "$GITHUB_OUTPUT"
      - name: Cargo build (release)
        run: cargo build --package llm-provider-cpu --release
      - name: Collect build outputs
        uses: actions/upload-artifact@v4
        with:
          name: ${{steps.version.outputs.tag}}-windows-llm-cpu
          path: |
            target/release/llm_provider.dll
  build-windows-bin:
    runs-on: windows-latest
    steps:
      - name: Checkout (full history & tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: MSVC environment
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
      - name: Compute version (inline)
        id: version
        shell: bash
        run: |
          chmod +x ./version.sh
          ./version.sh >> "$GITHUB_OUTPUT"
      - name: set version env
        shell: bash
        run: |
          echo "VERSION_TAG=${{ steps.version.outputs.tag }}" >> $GITHUB_ENV
      - name: Cargo build (release)
        run: cargo build --release

      - name: Collect build outputs
        uses: actions/upload-artifact@v4
        with:
          name: ${{steps.version.outputs.tag}}-windows-bin
          path: |
            target/release/${{env.ARTIFACT_BASENAME}}.exe
      - name: Collect steam dll
        uses: actions/upload-artifact@v4
        with:
          name: ${{steps.version.outputs.tag}}-windows-steam
          path: |
            target/release/build/steamworks-sys-*/out/steam_api64.dll


  build-linux-release:
    runs-on: ubuntu-latest
    needs: [build-linux-llm-cuda, build-linux-llm-cpu, build-linux-bin]
    steps:
      - name: Checkout (full history & tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: Compute version (inline)
        id: version
        shell: bash
        run: |
          chmod +x ./version.sh
          ./version.sh >> "$GITHUB_OUTPUT"
      - name: Python & Hugging Face CLI
        run: |
          python -m pip install --upgrade pip
          pip install -U "huggingface_hub"
      - name: Download models
        run: ./download_models.sh
      - uses: actions/download-artifact@v5
        with:
          path: target
          pattern: ${{steps.version.outputs.tag}}-linux-*
          merge-multiple: true
      - name: Prepare files
        id: collect
        run: |
          mv assets target/assets
          mv credits target/credits
          zip -r ${{env.ARTIFACT_BASENAME}}-linux.zip target/
      - name: Collect linux bin
        uses: actions/upload-artifact@v4
        with:
          name: ${{steps.version.outputs.tag}}-linux-release
          path: |
            ${{env.ARTIFACT_BASENAME}}-linux.zip
  build-windows-release:
    runs-on: ubuntu-latest
    needs: [build-windows-llm-cuda, build-windows-llm-cpu, build-windows-bin]
    steps:
      - name: Checkout (full history & tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: Compute version (inline)
        id: version
        shell: bash
        run: |
          chmod +x ./version.sh
          ./version.sh >> "$GITHUB_OUTPUT"
      - name: Python & Hugging Face CLI
        run: |
          python -m pip install --upgrade pip
          pip install -U "huggingface_hub"
      - name: Download models
        run: ./download_models.sh
      - uses: actions/download-artifact@v5
        with:
          path: target
          pattern: ${{steps.version.outputs.tag}}-windows-*
          merge-multiple: true
      - name: Prepare files
        id: collect
        run: |
          mv assets target/assets
          mv credits target/credits
          zip -r ${{env.ARTIFACT_BASENAME}}-windows.zip target/
      - name: Collect windows bin
        uses: actions/upload-artifact@v4
        with:
          name: ${{steps.version.outputs.tag}}-windows-release
          path: |
            ${{env.ARTIFACT_BASENAME}}-windows.zip
  create-release:
    runs-on: ubuntu-latest
    needs: [build-linux-release, build-windows-release]
    steps:
      - name: Checkout (full history & tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: Compute version (inline)
        id: version
        shell: bash
        run: |
          chmod +x ./version.sh
          ./version.sh >> "$GITHUB_OUTPUT"
      - name: Generate a changelog
        uses: orhun/git-cliff-action@v4
        id: git-cliff
        with:
          config: cliff.toml
          args: --unreleased --tag ${{steps.version.outputs.tag}} --strip header
      - uses: actions/download-artifact@v5
        with:
          pattern: ${{steps.version.outputs.tag}}-*-release
          merge-multiple: true
      - name: Display structure of downloaded files
        run: ls
      - name: Upload asset & create/update release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: "${{env.ARTIFACT_BASENAME}}-*.zip"
          file_glob: true
          tag: ${{ steps.version.outputs.tag }}
          release_name: ${{ steps.version.outputs.name }}
          body: |
            Automated build for ${{ steps.version.outputs.name }}.
            Channel: ${{ steps.version.outputs.channel }}.
            ${{steps.git-cliff.outputs.content}}
          prerelease: ${{ steps.version.outputs.prerelease }}
          overwrite: true
